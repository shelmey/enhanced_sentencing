unlist(lapply(nophone$`Phone Number`, function(x)is.null(x)))
unlist(lapply(nophone$`Phone Number`, function(x)!is.null(x)))
phone <- nophone[unlist(lapply(nophone$`Phone Number`, function(x)!is.null(x))),]
phone$`Phone Number` <- unlist(phone$`Phone Number`)
clipboard <- function(x){
con <- pipe("xclip -selection clipboard -i", open="w")
write(x, con)
close(con)
}
paste(paste(phone$`Phone Number`, phone$Given.Name, sep = ", "), collapse = "\n") %>% clipboard()
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
library(googlesheets4)
library(dplyr)
library(ggplot2)
library(scales)
library(kableExtra)
m2y <- function(x){
y = x%/%12
m = x-(12*y)
paste(y, "years and", m, "months")
}
auto_width <- function(x){
myKable <- x %>% kable %>% kable_styling("striped")
for (n in 1:length(x)) {
myKable <- column_spec(myKable, n, width_min = paste0(max(nchar(as.character(x[,n])))/1.7,"em"))
}
return(myKable)
}
jan6_sheet <- "1Uib3M6B7PYW6PZaOPZjhivzwJgE-bz2VqF5NSD9wmS0"
jan6All <- read_sheet(jan6_sheet)
jan6 <- jan6All %>% filter(Felony)
# Sentencing Guidelines from FJC IDB codebook
guidelines <-
rbind.data.frame(cbind("A", 0, 0 ),
cbind("B", 0, 6),
cbind("C", 7, 12),
cbind("0", 12, 24),
cbind("1", 24, 36),
cbind("2", 48, 60),
cbind("3", 72, 120),
cbind("4", 132, 180),
cbind("5", 192, 240),
cbind("6", 252, 300),
cbind("7", 300, 1200),
cbind("8", 10000, 10000),
cbind("9", 10000, 100000),
cbind("Z", NA, NA))
names(guidelines) <- c("SEV", "low", "high")
guidelines$low <- as.numeric(guidelines$low)
guidelines$high <- as.numeric(guidelines$high)
# Take the variables related to severity of filing and termination offenses, and get just the prison term part of that coded variable (the first character)
PSEV <- jan6[,grepl("SEV", names(jan6))] %>%
apply(1, substr, 1, 1) %>% t %>%
apply(1, function(x)gsub("[^ABC0-9]","",x)) %>% t %>%
apply(1, function(x)ifelse(x=="",NA,x)) %>% t %>%
as.data.frame %>%
mutate_all(factor, levels = c("A","B", "C", as.character(0:9)))
names(PSEV) <- paste0("P",names(PSEV))
# Get the sum of the severity indicators for each charge
jan6$PFSEVTOT <- PSEV[,grepl("PFSEV",names(PSEV))] %>%
mutate_all(function(x)case_when(is.na(x) ~ NA_real_, x == "A" ~ 0, x == "B" ~ 1, x == "C" ~ 2, TRUE ~ as.numeric(x)+3)) %>%
rowSums(na.rm = T)
# Get the max sentence for each case
jan6$myPRISTOT <- apply(jan6[,grepl("PRISTIM",names(jan6))],1,max, na.rm = T)
jan6$myPRISTOT[jan6$myPRISTOT==-1] <- 0
jan6$myPRISTOT[jan6$myPRISTOT<0] <- NA
# Get the actual amount of prison time recommended for each charge according to severity. Add that to the jan6 dataset
jan6guidelines <-
lapply(names(PSEV), function(n){
myData <- as.character(PSEV[[n]])
myData[is.na(myData)] <- "Z"
myData[!myData %in% guidelines$SEV]
myData <- bind_rows(lapply(myData,function(x)guidelines[guidelines$SEV == x,c(2,3)]))
names(myData) <- paste(n, names(myData), sep = "_")
myData
}) %>%
bind_cols
# Get the maximums of the high and low bounds for the prison guidelines for all the charges for each case
jan6$PTSEVh <- jan6guidelines[,grepl("T",names(jan6guidelines)) & grepl("high",names(jan6guidelines))] %>%
apply(1, max, na.rm = T)
jan6$PTSEVh[is.infinite(jan6$PTSEVh)] <- NA
jan6$PTSEVl <- jan6guidelines[,grepl("T",names(jan6guidelines)) & grepl("low",names(jan6guidelines))] %>%
apply(1, max, na.rm = T)
jan6$PTSEVl[is.infinite(jan6$PTSEVl)] <- NA
jan6 <- jan6 %>% cbind(PSEV)
# Replace the negative numbers representing NA values with NA
jan6$PRISTOT <- ifelse(jan6$PRISTOT %in% c(-3,-8), NA, jan6$PRISTOT)
jan6$PRISTOT <- ifelse(jan6$PRISTOT == -1, 0, jan6$PRISTOT)
# table(jan6$PRISTOT <= jan6$PTSEVh & jan6$PRISTOT >= jan6$PTSEVl)
# table(jan6$PRISTOT <= jan6$PTSEVh)
# jan6 %>% filter(PRISTOT > PTSEVh) %>% select(`Full legal name`,docketNumber, District, PTSEVh, PRISTOT)
# table(jan6$PRISTOT <= jan6$PTSEVl)
# summary(jan6$PTSEVh - jan6$PTSEVl)
# jan6[,c("PRISTOT", "PTSEVh", "PTSEVl")]
# Add on totals for offense levels too
FOFFLVL <- jan6[,grepl("FOFFLVL", names(jan6))] %>%
mutate_all(function(x)ifelse(x<0,NA,x))
jan6$FOFFLVLTOT <- FOFFLVL %>% rowSums(na.rm = T)
jan6$FOFFLVLTOT <- ifelse(jan6$FOFFLVLTOT == 0, NA, jan6$FOFFLVLTOT)
FOFFLVL <- FOFFLVL %>% mutate_all(factor, levels = c(1,3,4))
jan6[,grepl("FOFFLVL", names(jan6))] <- FOFFLVL
DISP <- jan6[, grepl("DISP[0-9]", names(jan6))] %>%
mutate_all(function(x)case_when(x == -8 ~ NA_character_, is.na(x) ~ NA_character_, x == 4 ~ "Convicted/final plea of guilty", x == 1 ~ "Dismissed", x == 15 ~ "Dismissed without prejudice", x == 9 ~ "Convicted by jury after trial", x == 2 ~ "Acquitted by court", x == 9 ~ "Convicted by jury after trial", x == 11 ~ "Nolle prosequi", TRUE ~ as.character(x)) %>% factor(ordered = TRUE, levels = c("Convicted by jury after trial", "Convicted/final plea of guilty", "Acquitted by court", "Nolle prosequi", "Dismissed without prejudice", "Dismissed")))
jan6$DISPmax <-  apply(DISP, 1, function(x){x[order(x)][1]})
SENTENCES <- jan6[,grepl("PRISTIM", names(jan6))] %>%
mutate_all(function(x)ifelse(x<0,NA,x))
FTITLE <- jan6[,grepl("FTITLE", names(jan6))] %>%
mutate_all(function(x)ifelse(x==-8,NA,x))
lookup <- jan6 %>%
filter(myPRISTOT > PTSEVl) %>%
select(Name,
Docket = `Case Number`,
`Prison Time (Months)` = PRISTOT,
`Guidelines Lower Bound` = PTSEVl,
`Guidelines Upper Bound` = PTSEVh)
jan6$`Filing Offenses` <- jan6[,grepl("FTITLE", names(jan6))] %>%
apply(1, function(x){
x <- x[!is.na(x) & x !=-8]
paste(x, collapse = ", ")})
jan6$sentenced <- !is.na(jan6$PRISTOT)
notSentenced <- jan6 %>% filter(
!sentenced
# !(as.Date(SENTDATE) > as.Date("2000-01-01"))
)
hasDisp <- notSentenced %>% filter(!is.na(DISP1) & DISP1!=-8)
hasDisp$DISP1 %>% table
noDisp <- notSentenced %>% filter(is.na(DISP1)|DISP1==-8)
noDisp$FILEDATE %>% summary
noDisp <- noDisp %>% arrange(FILEDATE)
jan6All$LOADDATE %>% max
jan6All$LOADDATE %>% max(na.rm = T)
jan6All$LOADDATE %>% table
library(googlesheets4)
library(dplyr)
library(ggplot2)
library(scales)
library(kableExtra)
m2y <- function(x){
y = x%/%12
m = x-(12*y)
paste(y, "years and", m, "months")
}
jan6_sheet <- "1Uib3M6B7PYW6PZaOPZjhivzwJgE-bz2VqF5NSD9wmS0"
jan6All <- read_sheet(jan6_sheet)
disps <- jan6All[, grepl("DISP[0-9]", names(jan6All))]
FOFFLVL <- jan6All[,grepl("FOFFLVL",names(jan6All))]
jan6All$Name %>% duplicated() %>%table
disps <- cbind(jan6All$Name, jan6All[, grepl("DISP[0-9]", names(jan6All))])
disps <- cbind(Name = jan6All$Name, jan6All[, grepl("DISP[0-9]", names(jan6All))])
FOFFLVL <- cbind(Name = jan6All$Name, jan6All[,grepl("FOFFLVL",names(jan6All))])
library(stringr)
names(disps) <- names(disps) %>% str_remove_all("DISP")
names(FOFFLVL) <- names(FOFFLVL) %>% str_remove_all("FOFFLVL")
install.packages("reshape2")
library(reshape2)
disps <- disps %>% melt
names(disps)[2]
names(disps)[2] <- "Offense"
names(disps)[3] <- "DISP"
FOFFLVL <- FOFFLVL %>% melt
names(FOFFLVL)[2] <- "Offense"
names(FOFFLVL)[3] <- "FOFFLVL"
disps <- disps %>% left_join(FOFFLVL)
TOFFLVL <- cbind(Name = jan6All$Name, jan6All[,grepl("TOFFLVL",names(jan6All))])
names(TOFFLVL) <- names(TOFFLVL) %>% str_remove_all("TOFFLVL")
disps <- cbind(Name = jan6All$Name, jan6All[, grepl("DISP[0-9]", names(jan6All))])
names(disps) <- names(disps) %>% str_remove_all("DISP")
TOFFLVL <- cbind(Name = jan6All$Name, jan6All[,grepl("TOFFLVL",names(jan6All))])
names(TOFFLVL) <- names(TOFFLVL) %>% str_remove_all("TOFFLVL")
disps <- disps %>% melt
names(disps)[2] <- "Offense"
names(disps)[3] <- "DISP"
TOFFLVL <- TOFFLVL %>% melt
names(TOFFLVL)[2] <- "Offense"
names(TOFFLVL)[3] <- "TOFFLVL"
disps <- disps %>% left_join(TOFFLVL)
table(disps$TOFFLVL)
disps$Tfelony <- disps$DISP %in% c(4,2,9) & disps$TOFFLVL == 4
disps_max <- disps %>%
group_by(Name) %>%
summarise(Tfelony = max(Tfelony,na.rm = T))
View(disps_max)
disps$Tfelony <- (disps$DISP %in% c(4,9)) & disps$TOFFLVL == 4
disps_max <- disps %>%
group_by(Name) %>%
summarise(Tfelony = max(Tfelony,na.rm = T))
View(disps_max)
jan6Pleas <- read_sheet(jan6_sheet, "Plea Agreements")
jan6Pleas <- jan6Pleas %>% left_join(disps_max)
jan6Pleas[,"Tfelony"]
jan6Pleas$Tfelony <- as.logical(jan6Pleas$Tfelony)
range_write(ss=jan6_sheet, sheet = "Plea Agreements 2", data = jan6Pleas[,"Tfelony"], range = "L2")
range_write(ss=jan6_sheet, sheet = "Plea Agreements", data = jan6Pleas[,"Tfelony"], range = "L2")
range_write(ss=jan6_sheet, sheet = "Plea Agreements", data = jan6Pleas[,"Tfelony"], range = "L1")
table(is.na(jan6All$FTITLE1))
table(is.na(jan6Pleas$FTITLE1))
table(is.na(jan6Pleas$TOFFLVL1))
table(jan6Pleas$TOFFLVL1 == -8)
table(is.na(jan6Pleas[jan6Pleas$Count3A1.4 == 1, "TOFFLVL1"]))
table(jan6Pleas[jan6Pleas$Count3A1.4 == 1, "TOFFLVL1"]==-8)
table(apply(jan6Pleas[jan6Pleas$Count3A1.4 == 1, grepl("TOFFLVL", names(jan6Pleas))],1,function(x)sum(x==-8)))
table(apply(jan6Pleas[jan6Pleas$Count3A1.4 == 1, grepl("TOFFLVL", names(jan6Pleas))],1,function(x)sum(is.na(x))))
TSEV <- cbind(Name = jan6All$Name, jan6All[, grepl("TSEV[0-9]", names(jan6All))])
names(TSEV) <- names(TSEV) %>% str_remove_all("TSEV")
TSEV <- TSEV %>% melt
names(TSEV)[2] <- "Offense"
names(TSEV)[3] <- "TSEV"
TSEV <- cbind(Name = jan6All$Name, jan6All[, grepl("TSEV[0-9]", names(jan6All))])
names(TSEV) <- names(TSEV) %>% str_remove_all("TSEV")
TSEV <- TSEV %>% melt
source("~/Projects/RichardDefense/enhanced_sentencing/update_felony.R", echo=TRUE)
TSEV <- cbind(Name = jan6All$Name, jan6All[, grepl("TSEV[0-9]", names(jan6All))])
names(TSEV) <- names(TSEV) %>% str_remove_all("TSEV")
TSEV <- TSEV %>% melt(id = "Name")
names(TSEV)[2] <- "Offense"
names(TSEV)[3] <- "TSEV"
TSEV$Type <- substr(TSEV$TSEV,2,2)
disps <- disps %>% left_join(TSEV)
type_max <- disps %>%
filter(DISP %in% c(4,9)) %>%
group_by(Name) %>%
summarise(Type = max(Type,na.rm = T))
type_max %>% table
type_max$Type %>% table
cbind.data.frame(Type = c(0:3),Offense_Type = c("None","Moral Terpitude","Property","Personal"))
types <- cbind.data.frame(Type = c(0:3),Offense_Type = c("None","Moral Terpitude","Property","Personal"))
type_max <- type_max %>% left_join(types)
TSEV <- cbind(Name = jan6All$Name, jan6All[, grepl("TSEV[0-9]", names(jan6All))])
names(TSEV) <- names(TSEV) %>% str_remove_all("TSEV")
TSEV <- TSEV %>% melt(id = "Name")
names(TSEV)[2] <- "Offense"
names(TSEV)[3] <- "TSEV"
TSEV$Type <- as.numeric(substr(TSEV$TSEV,2,2))
disps <- cbind(Name = jan6All$Name, jan6All[, grepl("DISP[0-9]", names(jan6All))])
names(disps) <- names(disps) %>% str_remove_all("DISP")
TOFFLVL <- cbind(Name = jan6All$Name, jan6All[,grepl("TOFFLVL",names(jan6All))])
names(TOFFLVL) <- names(TOFFLVL) %>% str_remove_all("TOFFLVL")
disps <- disps %>% melt
names(disps)[2] <- "Offense"
names(disps)[3] <- "DISP"
TOFFLVL <- TOFFLVL %>% melt
names(TOFFLVL)[2] <- "Offense"
names(TOFFLVL)[3] <- "TOFFLVL"
disps <- disps %>% left_join(TOFFLVL)
disps$Tfelony <- (disps$DISP %in% c(4,9)) & disps$TOFFLVL == 4
disps <- disps %>% left_join(TSEV)
type_max <- disps %>%
filter(DISP %in% c(4,9)) %>%
group_by(Name) %>%
summarise(Type = max(Type,na.rm = T))
type_max$Type %>% table
types <- cbind.data.frame(Type = c(0:3),Offense_Type = c("None","Moral Terpitude","Property","Personal"))
type_max <- type_max %>% left_join(types)
jan6Pleas <- read_sheet(jan6_sheet, "Plea Agreements")
jan6Pleas <- jan6Pleas %>% left_join(type_max)
range_write(ss=jan6_sheet, sheet = "Plea Agreements", data = jan6Pleas[,"Offense_Type"], range = "M1")
gsUrl <- "1g_kBPD5BiAf0hhXjjLgJojgJy_1_HKOO--YkIRZJ_nA"
blm_idb <- read_sheet(gsUrl, "Federal Cases w IDB cols")
myPleaUrls <- blm_idb$`Plea agreement`
myPleaUrls <- myPleaUrls[!is.na(myPleaUrls)]
blm_mentions <- read_sheet(gsUrl, "Count 3553")
library(rvest)
library(dplyr)
library(stringr)
library(pdftools)
library(googlesheets4)
library(googledrive)
gsUrl <- "1g_kBPD5BiAf0hhXjjLgJojgJy_1_HKOO--YkIRZJ_nA"
blm_idb <- read_sheet(gsUrl, "Federal Cases w IDB cols")
myPleaUrls <- blm_idb$`Plea agreement`
myPleaUrls <- myPleaUrls[!is.na(myPleaUrls)]
blm_mentions <- read_sheet(gsUrl, "Count 3553")
blm_mentions <- blm_mentions %>% left_join(select(blm_idb,`Case ID`, `Name of case`, docketNumber, District, `Plea agreement`))
myPleaUrls <- blm_mentions$`Plea agreement`[is.na(Count3553)]
myPleaUrls
myPleaUrls <- blm_mentions$`Plea agreement`[is.na(blm_mentions$Count3553)]
myPleaUrls
myPleaUrls <- blm_mentions$`Plea agreement`[is.na(blm_mentions$Count3553) & !is.na(blm_mentions$`Plea agreement`)]
pleaTexts <- lapply(myPleaUrls, function(x){
myPDF <- tempfile(fileext = ".pdf")
googledrive::drive_download(x, myPDF)
pdf_ocr_text(myPDF)
})
pleaTexts <- lapply(pleaTexts, paste, collapse = " ")
pleaTexts <- unlist(pleaTexts)
pleaTexts<-trimws(pleaTexts)
pleaTexts <- pleaTexts %>% str_replace_all("\\n"," ")
pleaTexts <- pleaTexts %>% str_replace_all("\\r"," ")
pleaTexts <- pleaTexts %>% str_replace_all(" +"," ")
pleaTextsSum <- lapply(pleaTexts,function(x)sum(grepl("3553",x), na.rm = T))
blm_mentions$Count3553[is.na(blm_mentions$Count3553) & !is.na(blm_mentions$`Plea agreement`)]
unlist(pleaTextsSum)
blm_mentions$Count3553[is.na(blm_mentions$Count3553) & !is.na(blm_mentions$`Plea agreement`)] <- unlist(pleaTextsSum)
blm_idb %>% select(`Case ID`, `Name of case`, docketNumber, District, Count3553) %>%
sheet_write(ss = gsUrl, sheet = "Count 3553")
blm_mentions %>% select(`Case ID`, `Name of case`, docketNumber, District, Count3553) %>%
sheet_write(ss = gsUrl, sheet = "Count 3553")
mySheet <- "12TXm_e9Hba-jv3g4GasbP2RLsfC-FtZpGWewcG8gJjg"
jan6 <- read_sheet(mySheet, "Source data")
terror_charges <- read.csv("Inputs/terror_titles.csv",stringsAsFactors = F, strip.white = T)
getwd()
setwd("/home/sam/Projects/RichardDefense")
ls
dir()
setwd("defend_richard")
dir()
setwd("/home/sam/Projects/RichardDefense")
setwd("enhanced_sentencing")
terror_charges <- read.csv("Inputs/terror_titles.csv",stringsAsFactors = F, strip.white = T)
myTitles <- paste(terror_charges$Title, terror_charges$Section, sep = ":") %>%
str_remove_all(" .*$") %>%
toupper() %>%
str_replace_all("[)(]+","\\.") %>%
str_remove_all("\\.$")
ttitles <- jan6[, grepl("TTITLE[0-9]", names(fed_idb))]
ttitles <- jan6[, grepl("TTITLE[0-9]", names(jan6))]
ftitles <- jan6[, grepl("FTITLE[0-9]", names(jan6))]
terrorMat <- apply(ttitles, 2, function(x)unlist(lapply(x,function(y)str_remove_all(y,"\\.") %in% str_remove_all(myTitles,"\\."))))
jan6$TTerror <- rowSums(terrorMat)>0
terrorMat <- apply(ftitles, 2, function(x)unlist(lapply(x,function(y)str_remove_all(y,"\\.") %in% str_remove_all(myTitles,"\\."))))
jan6$FTerror <- rowSums(terrorMat)>0
dickCharges <- c("18:111","18:1361")
dickMat <- apply(ttitles, 2, function(x)unlist(lapply(x,function(y)str_remove_all(y,"[^0-9\\:]") %in% dickCharges)))
jan6$TRH <- rowSums(dickMat)>0
jan6$TTerror  %>% table
ttitles
dc_codes <- read.csv("districts.csv", stringsAsFactors = F, strip.white = T)
View(dc_codes)
blm_idb <- read_sheet(gsUrl, "Federal Cases w IDB cols")
library(rvest)
library(dplyr)
library(stringr)
library(pdftools)
library(googlesheets4)
library(googledrive)
gsUrl <- "1g_kBPD5BiAf0hhXjjLgJojgJy_1_HKOO--YkIRZJ_nA"
blm_idb <- read_sheet(gsUrl, "Federal Cases w IDB cols")
myPleaUrls <- blm_idb$`Plea agreement`
myPleaUrls <- myPleaUrls[!is.na(myPleaUrls)]
pleaTexts <- lapply(myPleaUrls, function(x){
myPDF <- tempfile(fileext = ".pdf")
googledrive::drive_download(x, myPDF)
pdf_ocr_text(myPDF)
})
PSEV <- jan6[,grepl("TSEV", names(jan6))] %>%
apply(1, substr, 1, 1) %>% t %>%
apply(1, function(x)gsub("[^ABC0-9]","",x)) %>% t %>%
apply(1, function(x)ifelse(x=="",NA,x)) %>% t %>%
as.data.frame %>%
mutate_all(factor, levels = c("A","B", "C", as.character(0:9)))
View(PSEV)
names(PSEV) <- paste0("P",names(PSEV))
jan6$PFSEVTOT <- PSEV[,grepl("PFSEV",names(PSEV))] %>%
mutate_all(function(x)case_when(is.na(x) ~ NA_real_, x == "A" ~ 0, x == "B" ~ 1, x == "C" ~ 2, TRUE ~ as.numeric(x)+3)) %>%
apply(1,max,na.rm=T)
jan6$PFSEVTOT
jan6$PFSEVTOT <- PSEV[,grepl("PFSEV",names(PSEV))] %>%
mutate_all(function(x)case_when(is.na(x) ~ NA_real_, x == "A" ~ 0, x == "B" ~ 1, x == "C" ~ 2, TRUE ~ as.numeric(x)+3)) %>%
rowSums(na.rm = T)
summary(jan6$PFSEVTOT)
jan6$PFSEVTOT <- PSEV[,grepl("PTSEV",names(PSEV))] %>%
mutate_all(function(x)case_when(is.na(x) ~ NA_real_, x == "A" ~ 0, x == "B" ~ 1, x == "C" ~ 2, TRUE ~ as.numeric(x)+3)) %>%
rowSums(na.rm = T)
summary(jan6$PFSEVTOT)
jan6$PFSEVTOT <- PSEV[,grepl("PTSEV",names(PSEV))] %>%
mutate_all(function(x)case_when(is.na(x) ~ NA_real_, x == "A" ~ 0, x == "B" ~ 1, x == "C" ~ 2, TRUE ~ as.numeric(x)+3)) %>%
apply(1,max,na.rm = T)
summary(jan6$PFSEVTOT)
jan6$PFSEVTOT
jan6$TTerror[jan6$PFSEVTOT > 2 & !is.infinite(jan6$PFSEVTOT)]
table(jan6$PFSEVTOT > 2 & !is.infinite(jan6$PFSEVTOT))
jan6$Felony[jan6$PFSEVTOT > 2 & !is.infinite(jan6$PFSEVTOT)]
jan6$TTerror[jan6$PFSEVTOT > 2 & !is.infinite(jan6$PFSEVTOT)]
severe <- jan6 %>% filter(PFSEVTOT > 2 & !is.infinite(PFSEVTOT))
View(severe)
severe$TTerror %>% table
severe$TRH %>% table
jan6 <- read_sheet(mySheet, "Federal Cases w IDB cols")
pleaTexts <- lapply(pleaTexts, paste, collapse = " ")
pleaTexts <- unlist(pleaTexts)
pleaTexts<-trimws(pleaTexts)
pleaTexts <- pleaTexts %>% str_replace_all("\\n"," ")
pleaTexts <- pleaTexts %>% str_replace_all("\\r"," ")
pleaTexts <- pleaTexts %>% str_replace_all(" +"," ")
pleaTextsSum <- lapply(pleaTexts,function(x)sum(grepl("2332",x), na.rm = T))
pleaTextsSum
unlist(pleaTextsSum)
pleaTexts[1]
pleaTexts[2]
pleaTextsSum <- lapply(pleaTexts,function(x)sum(grepl("3A",x), na.rm = T))
unlist(pleaTextsSum)
pleaTextsSum <- lapply(pleaTexts,function(x)sum(grepl("3A1",x), na.rm = T))
unlist(pleaTextsSum)
pleaTexts[unlist(pleaTextsSum)>0]
pleaTextsSum <- lapply(pleaTexts,function(x)sum(grepl("3A1\\.",x), na.rm = T))
unlist(pleaTextsSum)
pleaTextsSum <- lapply(pleaTexts,function(x)sum(grepl("3A1\\.4",x), na.rm = T))
unlist(pleaTextsSum)
disps <- jan6[, grepl("DISP[0-9]", names(jan6))]
names(disps) <- names(disps) %>% str_remove_all("DISP")
TOFFLVL <- jan6[,grepl("TOFFLVL",names(jan6All))]
names(TOFFLVL) <- names(TOFFLVL) %>% str_remove_all("TOFFLVL")
TOFFLVL <- jan6[,grepl("TOFFLVL",names(jan6))]
names(TOFFLVL) <- names(TOFFLVL) %>% str_remove_all("TOFFLVL")
disps <- disps %>% melt
library(reshape2)
disps <- disps %>% melt
names(disps)[2] <- "Offense"
names(disps)[3] <- "DISP"
TOFFLVL <- TOFFLVL %>% melt
disps <- jan6[, grepl("DISP[0-9]", names(jan6))]
names(disps) <- names(disps) %>% str_remove_all("DISP")
TOFFLVL <- jan6[,grepl("TOFFLVL",names(jan6))]
names(TOFFLVL) <- names(TOFFLVL) %>% str_remove_all("TOFFLVL")
disps <- disps %>% melt
disps <- jan6[, grepl("DISP[0-9]", names(jan6))]
disps <- disps %>% melt
disps <- jan6[, grepl("DISP[0-9]", names(jan6))]
names(disps) <- names(disps) %>% str_remove_all("DISP")
disps <- disps %>% melt
names(disps)[2] <- "Offense"
names(disps)[3] <- "DISP"
disps <- cbind(Name = jan6$Name, jan6All[, grepl("DISP[0-9]", names(jan6))])
disps <- cbind(Name = jan6$Name, jan6[, grepl("DISP[0-9]", names(jan6))])
names(disps) <- names(disps) %>% str_remove_all("DISP")
TOFFLVL <- cbind(Name = jan6$Name, jan6[,grepl("TOFFLVL",names(jan6))])
names(TOFFLVL) <- names(TOFFLVL) %>% str_remove_all("TOFFLVL")
disps <- disps %>% melt
names(disps)[2] <- "Offense"
names(disps)[3] <- "DISP"
TOFFLVL <- TOFFLVL %>% melt
names(TOFFLVL)[2] <- "Offense"
names(TOFFLVL)[3] <- "TOFFLVL"
disps <- disps %>% left_join(TOFFLVL)
disps$Tfelony <- (disps$DISP %in% c(4,9)) & disps$TOFFLVL == 4
disps_max <- disps %>%
group_by(Name) %>%
summarise(Tfelony = max(Tfelony,na.rm = T))
jan6 <- jan6 %>% left_join(disps_max)
jan6Pleas$Tfelony <- as.logical(jan6Pleas$Tfelony)
jan6$Tfelony <- as.logical(jan6$Tfelony)
severe <- jan6 %>% filter(PFSEVTOT > 2 & !is.infinite(PFSEVTOT))
severe$Tfelony %>% table
severe <- jan6 %>% filter(PFSEVTOT > 2 & !is.infinite(PFSEVTOT) & TFelony)
severe <- jan6 %>% filter(PFSEVTOT > 2 & !is.infinite(PFSEVTOT) & Tfelony)
plea_agreements <- read_sheet(mySheet, "Source data")
plea_agreements <- read_sheet(mySheet, "Plea Agreements")
severe <- severe %>% left_join(select(plea_agreements, Name, Count3A1.4))
severe$Count3A1.4 %>% table
severe <- jan6 %>% filter(PFSEVTOT > 8 & !is.infinite(PFSEVTOT) & Tfelony)
severe <- severe %>% left_join(select(plea_agreements, Name, Count3A1.4))
severe$Count3A1.4 %>% table
severe$PFSEVTOT[severe$Count3A1.4==0]
PSEV <- jan6[,grepl("TSEV", names(jan6))] %>%
apply(1, substr, 1, 1) %>% t %>%
apply(1, function(x)gsub("[^ABC0-9]","",x)) %>% t %>%
apply(1, function(x)ifelse(x=="",NA,x)) %>% t %>%
as.data.frame %>%
mutate_all(factor, levels = c("A","B", "C", as.character(0:9)))
names(PSEV) <- paste0("P",names(PSEV))
jan6$PFSEVTOT <- PSEV[,grepl("PTSEV",names(PSEV))] %>%
mutate_all(as.character) %>%
mutate_all(function(x)case_when(is.na(x) ~ NA_real_, x == "A" ~ 0, x == "B" ~ 1, x == "C" ~ 2, TRUE ~ as.numeric(x)+3)) %>%
apply(1,max,na.rm = T)
jan6$PFSEVTOT
severe <- jan6 %>% filter(PFSEVTOT > 8 & !is.infinite(PFSEVTOT) & Tfelony)
plea_agreements <- read_sheet(mySheet, "Plea Agreements")
severe <- severe %>% left_join(select(plea_agreements, Name, Count3A1.4))
severe$Count3A1.4 %>% table
severe$PFSEVTOT[severe$Count3A1.4==0]
severe <- jan6 %>% filter(PFSEVTOT > 4 & !is.infinite(PFSEVTOT) & Tfelony)
severe <- severe %>% left_join(select(plea_agreements, Name, Count3A1.4))
severe$Count3A1.4 %>% table
severe$PFSEVTOT[severe$Count3A1.4==0]
severe %>% filter(3A1.4 == 0) %>% select(Name, docketNumber, DISTRICT)
severe %>% filter(Count3A1.4 == 0) %>% select(Name, docketNumber, DISTRICT)
severe %>% filter(Count3A1.4 == 0) %>% select(Name, docketNumber, DISTRICT, `Charge(s)`)
severe %>% filter(Count3A1.4 == 0) %>%
sheet_write(mySheet,"Severe Termination Offenses")
library(rvest)
library(dplyr)
library(stringr)
library(pdftools)
library(googlesheets4)
base_url <- "https://www.justice.gov"
# Look for 'U.S.S.G. § 3A1.4'
jan6url <- "https://www.justice.gov/usao-dc/capitol-breach-cases"
gsUrl <- "12TXm_e9Hba-jv3g4GasbP2RLsfC-FtZpGWewcG8gJjg"
jan6_idb <- read_sheet(gsUrl)
jan6_idb <- read_sheet(gsUrl, "Source data")
# parse with rvest
myLinks <- jan6url %>%
read_html() %>%
html_nodes("a")
myUrls <- myLinks %>%
html_attr('href')
myLinks <- myLinks %>%
html_text()
myUrls <- paste0(base_url, myUrls)
myPleaUrls <- myUrls[grepl("Plea Agreement", myLinks)]
pleaTexts <- lapply(myPleaUrls, pdf_text)
nPleaAgreements <- str_count(df$`Case Documents`, "Plea Agreement")
nPleaAgreements <- str_count(jan6_idb$`Case Documents`, "Plea Agreement")
nPleaAgreements[is.na(nPleaAgreements)] <- 0
pleaNames <- unlist(lapply(1:nrow(jan6_idb),function(n)rep(jan6_idb$Name[n],nPleaAgreements[n])))
Plea_Terror <- cbind.data.frame(Name = pleaNames, url = myPleaUrls)
DateRegex <- paste(paste0(month.name," [0-9]{1,2}, +202[0-2]{1}"), collapse = "|")
Plea_Terror$Date <- unlist(lapply(pleaTexts,function(x)str_extract(x[1], DateRegex)))
Plea_Terror$Date
noDate <- is.na(Plea_Terror$Date)
noDateText <- lapply(myPleaUrls[noDate], pdf_ocr_text)
